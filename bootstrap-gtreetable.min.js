(function(e){function b(g,f){this.options=f;this.$tree=e(g);this.language=this.options.languages[this.options.language]===undefined?this.options.languages.en:e.extend({},this.options.languages.en,this.options.languages[this.options.language]);this._isNodeDragging=false;this._lastId=0;var i=this.language;if(this.options.template===undefined){var h='<table class="table gtreetable"><tr class="'+this.options.classes.node+" "+this.options.classes.collapsed+'"><td><span>';if(this.options.draggable===true){h+='<span class="'+this.options.classes.handleIcon+'">&zwnj;</span><span class="'+this.options.classes.draggablePointer+'">&zwnj;</span>'}h+='<span class="'+this.options.classes.indent+'">&zwnj;</span><span class="'+this.options.classes.ceIcon+' icon"></span><span class="'+this.options.classes.selectedIcon+' icon"></span><span class="'+this.options.classes.typeIcon+'"></span><span class="'+this.options.classes.name+'"></span></span><span class="hide '+this.options.classes.action+'"><input type="text" name="name" value="" style="width: '+this.options.inputWidth+'" class="form-control" /><button type="button" class="btn btn-sm btn-primary '+this.options.classes.saveButton+'">'+i.save+'</button> <button type="button" class="btn btn-sm '+this.options.classes.cancelButton+'">'+i.cancel+'</button></span><div class="btn-group pull-right"><button type="button" class="btn btn-sm btn-default dropdown-toggle node-actions" data-toggle="dropdown">'+i.action+' <span class="caret"></span></button><ul class="dropdown-menu" role="menu"><li role="presentation" class="dropdown-header">'+i.action+"</li>";this.actions=[];if(this.options.defaultActions!==null){this.actions=this.options.defaultActions}if(this.options.actions!==undefined){this.actions.push.apply(this.actions,this.options.actions)}e.each(this.actions,function(k,m){if(m.divider===true){h+='<li class="divider"></li>'}else{var l=m.name.match(/\{([\w\W]+)\}/),j=l!==null&&l[1]!==undefined&&i.actions[l[1]]!==undefined?i.actions[l[1]]:m.name;h+='<li role="presentation"><a href="#notarget" class="node-action-'+k+'" tabindex="-1">'+j+"</a></li>"}});h+="</ul></div></td></tr></table>";this.options.template=h}if(this.$tree.find("tbody").length===0){this.$tree.append("<tbody></tbody>")}if(!this.options.readonly){this.$tree.addClass("gtreetable-fullAccess")}this.$nodeTemplate=e(this.options.templateSelector!==undefined?this.options.templateSelector:this.options.template).find("."+this.options.classes.node);if(this.options.draggable===true){this.isNodeDragging(false)}this.init()}b.prototype.VERSION="2.0a";b.prototype={getNode:function(f){return f.data("bs.gtreetable.gtreetablenode")},getNodeById:function(f){return this.getNode(this.$tree.find("."+this.options.classes.node+"[data-id='"+f+"']"))},getSelectedNodes:function(){var g=[],f=this;e.each(this.$tree.find("."+this.options.classes.selected),function(){g.push(f.getNode(e(this)))});return g},getSourceNodes:function(g){var f=this;return e.ajax({type:"GET",url:f.options.source(g),dataType:"json",beforeSend:function(){if(g>0){f.getNodeById(g).isLoading(true)}},success:function(i){for(var h=0;h<i.length;h+=1){i[h].parent=g}if(typeof f.options.sort==="function"){i.sort(f.options.sort)}},error:function(h){alert(h.status+": "+h.responseText)},complete:function(){if(g>0){f.getNodeById(g).isLoading(false)}}})},init:function(){var f=this;this.getSourceNodes(0).done(function(i){for(var g in i){var h=new c(i[g],f);h.insertIntegral(h)}})},isNodeDragging:function(f){if(f===undefined){return this._isNodeDragging}else{if(f===true){this._isNodeDragging=true;this.$tree.disableSelection()}else{this._isNodeDragging=false;this.$tree.enableSelection()}}},generateNewId:function(){this._lastId+=1;return"g"+this._lastId}};function c(g,f){this.manager=f;this.level=g.level;this.parent=g.parent;this.name=g.name;this.type=g.type;this.id=g.id;this.insertPosition=undefined;this.movePosition=undefined;this.relatedNodeId=undefined;this._isExpanded=false;this._isLoading=false;this._isSaved=g.id===undefined?false:true;this._isSelected=false;this._isHovered=false;this._isEditable=false;this.init()}c.prototype={getPath:function(){var h=this,g=[h.name],f=h.parent;h.$node.prevAll("."+this.manager.options.classes.node).each(function(){var i=h.manager.getNode(e(this));if(i.id===f){f=i.parent;g[g.length]=i.name}});return g},getParents:function(){var f=[],h=this.parent;while(true){if(h===0){break}var g=this.manager.getNodeById(h);f.push(g);h=g.parent}return f},getSiblings:function(){var k=this,j=[],h="."+k.manager.options.classes.node+"[data-parent='"+k.parent+"']",g=k.$node.prevAll(h);for(var f=g.length-1;f>=0;--f){j.push(k.manager.getNode(e(g[f])))}j.push(k);k.$node.nextAll(h).each(function(){j.push(k.manager.getNode(e(this)))});return j},getDescendants:function(h){var f=this,i=e.extend({},{depth:1,includeNotSaved:false,index:undefined},h),j="."+f.manager.options.classes.node,k=i.depth!==-1||isNaN(i.depth)?i.depth:Infinity,l=[];if((i.includeNotSaved===false)){j+="."+f.manager.options.classes.saved}if(k>1){f.$node.nextAll(j).each(function(){var m=f.manager.getNode(e(this));if((m.level<=f.level)||(m.level===f.level&&m.parent===f.parent)){if(!(i.includeNotSaved===true&&!m.isSaved())){return false}}l.push(m)})}else{f.$node.nextAll(j+"[data-parent='"+f.id+"'][data-level='"+(f.level+1)+"']").each(function(){l.push(f.manager.getNode(e(this)))})}if(!isNaN(i.index)){var g=i.index>=0?i.index-1:l.length+i.index;return l[g]}return l},getMovePosition:function(){return this.movePosition},setMovePosition:function(f,g){this.$node.removeClass(this.manager.options.classes.draggableContainer);if(f!==undefined){this.$node.addClass(this.manager.options.classes.draggableContainer);this.movePosition=f;this.$pointer.css("top",g.top+"px");this.$pointer.css("left",g.left+"px")}},getId:function(){return this.id},getName:function(){return this.isEditable()?this.$input.val():this.name},getParent:function(){return this.parent},getInsertPosition:function(){return this.insertPosition},getRelatedNodeId:function(){return this.relatedNodeId},init:function(){this.$node=this.manager.$nodeTemplate.clone(false);this.$name=this.$node.find("."+this.manager.options.classes.name);this.$ceIcon=this.$node.find("."+this.manager.options.classes.ceIcon);this.$typeIcon=this.$node.find("."+this.manager.options.classes.typeIcon);this.$icon=this.$node.find("."+this.manager.options.classes.icon);this.$action=this.$node.find("."+this.manager.options.classes.action);this.$indent=this.$node.find("."+this.manager.options.classes.indent);this.$saveButton=this.$node.find("."+this.manager.options.classes.saveButton);this.$cancelButton=this.$node.find("."+this.manager.options.classes.cancelButton);this.$input=this.$node.find("input");this.$pointer=this.$node.find("."+this.manager.options.classes.draggablePointer);this.render();this.attachEvents();this.$node.data("bs.gtreetable.gtreetablenode",this)},render:function(){this.$name.html(this.name);if(this.id!==undefined){this.$node.attr("data-id",this.id);this.isSaved(true);if(this.manager.options.draggable===true){this.$node.addClass(this.manager.options.classes.draggable)}}this.$node.attr("data-parent",this.parent);this.$node.attr("data-level",this.level);this.$indent.css("marginLeft",((parseInt(this.level,10)-1)*this.manager.options.nodeIndent)+"px").html("&zwnj;");if(this.type!==undefined&&this.manager.options.types&&this.manager.options.types[this.type]!==undefined){this.$typeIcon.addClass(this.manager.options.types[this.type]).show()}},attachEvents:function(){var g=this;this.$node.mouseover(function(){if(!(g.manager.options.draggable===true&&g.manager.isNodeDragging()===true)){g.$node.addClass(g.manager.options.classes.hovered);g.isHovered(true)}});this.$node.mouseleave(function(){g.$node.removeClass(g.manager.options.classes.hovered);g.isHovered(false)});this.$name.click(function(h){if(g.isSelected()){if(e.isFunction(g.manager.options.onUnselect)){g.manager.options.onUnselect(g)}g.isSelected(false)}else{var i=g.manager.getSelectedNodes();if(g.manager.options.multiselect===false){if(i.length===1){i[0].isSelected(false)}}else{if(!isNaN(g.manager.options.multiselect)&&g.manager.options.multiselect===i.length){if(e.isFunction(g.options.onSelectOverflow)){g.options.onSelectOverflow(g)}h.preventDefault()}}g.isSelected(true);if(e.isFunction(g.manager.options.onSelect)){g.manager.options.onSelect(g)}}});this.$ceIcon.click(function(h){if(!g.isExpanded()){g.expand()}else{g.collapse()}});if(g.manager.options.dragCanExpand===true){this.$ceIcon.mouseover(function(h){if(g.manager.options.draggable===true&&g.manager.isNodeDragging()===true){if(!g.isExpanded()){g.expand()}}})}e.each(this.manager.actions,function(h,i){g.$node.find("."+g.manager.options.classes.action+"-"+h).click(function(j){i.event(g,g.manager)})});this.$saveButton.click(function(){g.save()});this.$cancelButton.click(function(){g.saveCancel()});if(g.manager.options.draggable===true){function f(n,l){var k=n.offset.top-l.offset().top,i=l.offset().top,m=l.outerHeight(),o=m-(n.helper.outerHeight()/2),h=undefined,j={left:g.manager.$tree.offset().left+5};if(k<=(o*0.3)){h="before";j.top=(i+3)}else{if(k<=(o*0.7)){h="lastChild";j.top=i+Math.round(o/2)}else{h="after";j.top=i+o}}return{position:h,pointerOffset:j}}this.$node.draggable({scroll:true,refreshPositions:g.manager.options.dragCanExpand,helper:function(i){var h=g.manager.getNode(e(this));return'<mark class="'+g.manager.options.classes.draggableHelper+'">'+h.name+"</mark>"},cursorAt:{top:0,left:0},handle:"."+g.manager.options.classes.handleIcon,start:function(h){if(!e.browser.webkit){e(this).data("bs.gtreetable.gtreetablenode.scrollTop",e(window).scrollTop())}},stop:function(h){g.manager.isNodeDragging(false)},drag:function(l,k){if(!e.browser.webkit){var h=e(window).scrollTop(),m=(e(this).data("bs.gtreetable.gtreetablenode.scrollTop")-h);k.position.top-=h+m;e(this).data("bs.gtreetable.gtreetablenode.startingScrollTop",h)}var i=e(this).data("bs.gtreetable.gtreetablenode.currentDroppable");if(i){var j=f(k,i);g.manager.getNode(i).setMovePosition(j.position,j.pointerOffset)}}}).droppable({accept:"."+g.manager.options.classes.node,over:function(h,j){var k=e(this),i=f(j,k);g.manager.getNode(k).setMovePosition(i.position,i.pointerOffset);j.draggable.data("bs.gtreetable.gtreetablenode.currentDroppable",k)},out:function(h,i){i.draggable.removeData("bs.gtreetable.gtreetablenode.currentDroppable");g.manager.getNode(e(this)).setMovePosition()},drop:function(i,j){var k=e(this),l=g.manager.getNode(k),h=l.getMovePosition();j.draggable.removeData("bs.gtreetable.gtreetablenode.currentDroppable");l.setMovePosition();g.manager.getNode(j.draggable).move(l,h)}})}},makeEditable:function(){this.showForm(true)},save:function(){var f=this;if(e.isFunction(f.manager.options.onSave)){e.when(f.manager.options.onSave(f)).done(function(g){f._save(g)})}else{f._save({name:f.getName(),id:f.manager.generateNewId()})}},_save:function(f){var g=this;g.id=f.id;g.name=f.name;if(e.isFunction(g.manager.options.sort)){g.sort()}g.render();g.showForm(false);g.isHovered(false)},saveCancel:function(){this.showForm(false);if(!this.isSaved()){this._remove()}},expand:function(g){var i=this,f=i,h=e.extend({},{onAfterFill:function(k,j){k.isExpanded(true);if(j.length===0){if(k.manager.options.showExpandIconOnEmpty===true){k.isExpanded(false)}else{k.showCeIcon(false)}}}},g);e.when(this.manager.getSourceNodes(i.id)).done(function(l){for(var j in l){var k=new c(l[j],i.manager);i.insertIntegral(k,f);f=k}if(h&&typeof e.isFunction(h.onAfterFill)){h.onAfterFill(i,l)}})},collapse:function(){this.isExpanded(false);e.each(this.getDescendants({depth:-1,includeNotSaved:true}),function(){this.$node.remove()})},_canAdd:function(f){var g={result:!(f.parent===0&&this.manager.options.manyroots===false)};if(!g.result){g.message=this.manager.language.messages.onNewRootNotAllowed}return g},add:function(f,l){var k=this,h=(f==="lastChild"||f==="firstChild"),j=new c({level:k.level+(h?1:0),parent:k.level===1&&!h?0:(h?k.id:k.parent),type:l},this.manager),g=this._canAdd(j);if(!g.result){alert(g.message);return false}function i(){if(h){k.isExpanded(true);k.showCeIcon(true)}j.insert(f,k);j.insertPosition=f;j.relatedNodeId=k.id;j.showForm(true)}if(h&&!k.isExpanded()){k.expand({onAfterFill:function(){i()}})}else{i()}},insert:function(f,h){var j=this;if(f==="before"){h.$node.before(j.$node)}else{if(f==="after"){var g=h;if(h.isExpanded()){var i=h.getDescendants({depth:1,index:-1,includeNotSaved:true});g=i===undefined?g:i}g.$node.after(j.$node)}else{if(f==="firstChild"){this.manager.getNodeById(h.id).$node.after(j.$node)}else{if(f==="lastChild"){var i=h.getDescendants({depth:1,index:-1,includeNotSaved:true});var g=i===undefined?h:i;g.$node.after(j.$node)}else{throw"Wrong position."}}}}},insertIntegral:function(f,g){if(g===undefined){this.manager.$tree.append(f.$node)}else{g.$node.after(f.$node)}},remove:function(){var f=this;if(f.isSaved()&&e.isFunction(f.manager.options.onDelete)){e.when(f.manager.options.onDelete(f)).done(function(){f._remove()})}else{this._remove()}},_remove:function(){if(this.isExpanded()===true){this.collapse()}this.$node.remove();if(this.parent>0){var f=this.manager.getNodeById(this.parent);if(f.getDescendants({depth:1,includeNotSaved:true}).length===0){f.collapse()}}},_canMove:function(h){var g=this,f={result:true};if(h.parent===0&&this.manager.options.manyroots===false){f.result=false;f.message=this.manager.language.messages.onMoveAsRoot}else{e.each(h.getParents(),function(){if(this.id===g.id){f.result=false;f.message=this.manager.language.messages.onMoveInDescendant;return false}})}return f},move:function(i,f){var h=this,g=this._canMove(i,f);if(g.result===false){alert(g.message);return false}if(e.isFunction(h.manager.options.onMove)){e.when(h.manager.options.onMove(h,i,f)).done(function(j){h._move(i,f)})}else{h._move(i,f)}},_move:function(j,f){var i=this,h=i.getDescendants({depth:-1,includeNotSaved:true}),l=i.manager.getNodeById(i.parent),k=j.level-i.level;i.parent=f==="lastChild"?j.id:j.parent;i.level=j.level;if(f==="lastChild"&&!j.isExpanded()){i.$node.remove();e.each(h,function(){this.$node.remove()})}else{if(f==="lastChild"){i.level+=1;j.showCeIcon(true)}i.render();i.insert(f,j);if(h.length>0){var g=i.$node;if(f==="lastChild"){k+=1}e.each(h,function(){var m=this;m.level+=k;m.render();g.after(m.$node);g=m.$node})}}if(l!==undefined&&l.getDescendants({depth:1,includeNotSaved:true}).length===0){l.isExpanded(false)}if(e.isFunction(i.manager.options.sort)){i.sort()}},sort:function(){var h=this,j=h.getSiblings();if(j.length>0){var i=!h.isExpanded()?[]:h.getDescendants({depth:-1,includeNotSaved:true}),g=undefined;e.each(j,function(){if(h.manager.options.sort(h,this)===-1){g=this;return false}});if(g===undefined){g=j[j.length-1];if(g.isExpanded()){g=h.manager.getNodeById(h.parent).getDescendants({depth:-1,index:-1,includeNotSaved:true})}g.$node.after(h.$node)}else{g.$node.before(h.$node)}var f=h.$node;e.each(i,function(){var k=this;f.after(k.$node);f=k.$node})}},isLoading:function(f){if(f===undefined){return this._isLoading}else{if(f){this.$name.addClass(this.manager.options.classes.loading);this._isLoading=true}else{this.$name.removeClass(this.manager.options.classes.loading);this._isLoading=false}}},isSaved:function(f){if(f===undefined){return this._isSaved}else{if(f){this.$node.addClass(this.manager.options.classes.saved);this._isSaved=true}else{this.$node.removeClass(this.manager.options.classes.saved);this._isSaved=false}}},isSelected:function(f){if(f===undefined){return this._isSelected}else{if(f){this.$node.addClass(this.manager.options.classes.selected);this._isSelected=true}else{this.$node.removeClass(this.manager.options.classes.selected);this._isSelected=false}}},isExpanded:function(f){if(f===undefined){return this._isExpanded}else{if(f){this.$node.addClass(this.manager.options.classes.expanded).removeClass(this.manager.options.classes.collapsed);this._isExpanded=true}else{this.$node.addClass(this.manager.options.classes.collapsed).removeClass(this.manager.options.classes.expanded);this._isExpanded=false}}},isHovered:function(f){if(f===undefined){return this._isHovered}else{if(f){this.$node.addClass(this.manager.options.classes.hovered);this._isHovered=true}else{this.$node.removeClass(this.manager.options.classes.hovered);this.$node.find(".btn-group").removeClass("open");this._isHovered=false}}},isEditable:function(f){if(f===undefined){return this._isEditable}else{this._isEditable=f}},showCeIcon:function(f){this.$ceIcon.css("visibility",f?"visible":"hidden")},showForm:function(f){if(f===true){this.isEditable(true);this.$input.val(this.name);this.$name.addClass("hide");this.$action.removeClass("hide");this.$input.focus()}else{this.isEditable(false);this.$name.removeClass("hide");this.$action.addClass("hide")}}};function d(g,h){var f=null;this.each(function(){var k=e(this),j=k.data("bs.gtreetable"),i=e.extend({},e.fn.gtreetable.defaults,k.data(),typeof g==="object"&&g);if(!j){j=new b(this,i);k.data("bs.gtreetable",j)}if(typeof g==="string"){f=j[g](h)}});if(!f){f=this}return f}var a=e.fn.gtreetable;e.fn.gtreetable=d;e.fn.gtreetable.Constructor=b;e.fn.gtreetable.defaults={nodeIndent:16,language:"en",inputWidth:"60%",readonly:false,multiselect:false,manyroots:false,draggable:false,dragCanExpand:false,showExpandIconOnEmpty:false,languages:{en:{save:"Save",cancel:"Cancel",action:"Action",actions:{addBefore:"Add before",addAfter:"Add after",addFirstChild:"Add first child",addLastChild:"Add last child",edit:"Edit","delete":"Delete"},messages:{onDelete:"Are you sure?",onNewRootNotAllowed:"Adding the now node as root is not allowed.",onMoveInDescendant:"The target node should not be descendant.",onMoveAsRoot:"The target node should not be root."}}},defaultActions:[{name:"{addBefore}",event:function(g,f){g.add("before","default")}},{name:"{addAfter}",event:function(g,f){g.add("after","default")}},{name:"{addFirstChild}",event:function(g,f){g.add("firstChild","default")}},{name:"{addLastChild}",event:function(g,f){g.add("lastChild","default")}},{divider:true},{name:"{edit}",event:function(g,f){g.makeEditable()}},{name:"{delete}",event:function(g,f){if(confirm(f.language.messages.onDelete)){g.remove()}}}],classes:{node:"node",loading:"node-loading",selected:"node-selected",hovered:"node-hovered",expanded:"node-expanded",collapsed:"node-collapsed",draggable:"node-draggable",draggableHelper:"node-draggable-helper",draggablePointer:"node-draggable-pointer",draggableContainer:"node-draggable-container",saved:"node-saved",name:"node-name",icon:"node-icon",selectedIcon:"node-icon-selected",ceIcon:"node-icon-ce",typeIcon:"node-icon-type",handleIcon:"node-icon-handle",action:"node-action",indent:"node-indent",saveButton:"node-save",cancelButton:"node-cancel"}};e.fn.gtreetable.noConflict=function(){e.fn.gtreetable=a;return this}}(jQuery));