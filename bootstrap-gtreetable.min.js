(function(e){function b(g,f){this.options=f;this.$tree=e(g);this.language=this.options.languages[this.options.language]===undefined?this.options.languages.en:this.options.languages[this.options.language];this._isNodeDragging=false;var i=this.language;if(this.options.template===undefined){var h='<table class="table gtreetable"><tr class="'+this.options.classes.node+" "+this.options.classes.collapsed+'"><td><span>';if(this.options.draggable===true){h+='<span class="'+this.options.classes.handleIcon+'">&zwnj;</span><span class="'+this.options.classes.draggablePointer+'">&zwnj;</span>'}h+='<span class="'+this.options.classes.indent+'">&zwnj;</span><span class="'+this.options.classes.ceIcon+' icon"></span><span class="'+this.options.classes.selectedIcon+' icon"></span><span class="'+this.options.classes.typeIcon+'"></span><span class="'+this.options.classes.name+'"></span></span><span class="hide '+this.options.classes.action+'"><input type="text" name="name" value="" style="width: '+this.options.inputWidth+'" class="form-control" /><button type="button" class="btn btn-sm btn-primary '+this.options.classes.saveButton+'">'+i.save+'</button> <button type="button" class="btn btn-sm '+this.options.classes.cancelButton+'">'+i.cancel+'</button></span><div class="btn-group pull-right"><button type="button" class="btn btn-sm btn-default dropdown-toggle node-actions" data-toggle="dropdown">'+i.action+' <span class="caret"></span></button><ul class="dropdown-menu" role="menu"><li role="presentation" class="dropdown-header">'+i.action+"</li>";this.actions=[];if(this.options.defaultActions!==null){this.actions=this.options.defaultActions}if(this.options.actions!==undefined){this.actions.push.apply(this.actions,this.options.actions)}e.each(this.actions,function(k,m){if(m.divider===true){h+='<li class="divider"></li>'}else{var l=m.name.match(/\{([\w\W]+)\}/),j=l!==null&&l[1]!==undefined&&i[l[1]]!==undefined?i[l[1]]:m.name;h+='<li role="presentation"><a href="#notarget" class="node-action-'+k+'" tabindex="-1">'+j+"</a></li>"}});h+="</ul></div></td></tr></table>";this.options.template=h}if(this.$tree.find("tbody").length===0){this.$tree.append("<tbody></tbody>")}if(!this.options.readonly){this.$tree.addClass("gtreetable-fullAccess")}this.$nodeTemplate=e(this.options.templateSelector!==undefined?this.options.templateSelector:this.options.template).find("."+this.options.classes.node);if(this.options.draggable===true){this.isNodeDragging(false)}this.init()}b.prototype.VERSION="2.0a";b.prototype={getNode:function(f){return f.data("bs.gtreetable.gtreetablenode")},getNodeById:function(f){return this.getNode(this.$tree.find("."+this.options.classes.node+f))},getNodePath:function(j){var h=this.getNodeById(j),g=this,i=[h.name],f=h.parent;h.$node.prevAll("."+this.options.classes.node).each(function(){var k=g.getNode(e(this));if(k.id===f){f=k.parent;i[i.length]=k.name}});return i},getSelectedNodes:function(){var g=[],f=this;e.each(this.$tree.find("."+this.options.classes.selected),function(){g.push(f.getNode(e(this)))});return g},getSourceNodes:function(g){var f=this;return e.ajax({type:"GET",url:f.options.source(g),dataType:"json",beforeSend:function(){if(g>0){f.getNodeById(g).isLoading(true)}},success:function(i){for(var h=0;h<i.length;h+=1){i[h].parent=g}if(typeof f.options.sort==="function"){i.sort(f.options.sort)}},error:function(h){alert(h.status+": "+h.responseText)},complete:function(){if(g>0){f.getNodeById(g).isLoading(false)}}})},getDescendants:function(f,h){var j=this,i=e.extend({},{depth:1,includeNotSaved:false,index:undefined},h),k="."+this.options.classes.node,l=i.depth!==-1||isNaN(i.depth)?i.depth:Infinity,m=[];if((i.includeNotSaved===false)){k+="."+this.options.classes.saved}if(l>1){f.$node.nextAll(k).each(function(){var n=j.getNode(e(this));if((n.level<=f.level)||(n.level===f.level&&n.parent===f.parent)){if(!(i.includeNotSaved===true&&!n.isSaved())){return false}}m.push(n)})}else{f.$node.nextAll(k+"[data-parent='"+f.id+"'][data-level='"+(f.level+1)+"']").each(function(){m.push(j.getNode(e(this)))})}if(!isNaN(i.index)){var g=i.index>=0?i.index-1:m.length+i.index;return m[g]}return m},getSiblings:function(l){var h=this,k=[],j="."+this.options.classes.node+"[data-parent='"+l.parent+"']",g=l.$node.prevAll(j);for(var f=g.length-1;f>=0;--f){k.push(h.getNode(e(g[f])))}k.push(l);l.$node.nextAll(j).each(function(){k.push(h.getNode(e(this)))});return k},init:function(){var f=this;this.getSourceNodes(0).done(function(h){for(var g in h){f.insertIntegral(new c(h[g],f))}})},expand:function(i,f){var h=this,g=e.extend({},{onAfterFill:function(k,j){k.isExpanded(true);if(j.length===0){if(h.options.showExpandIconOnEmpty===true){k.isExpanded(false)}else{k.showCeIcon(false)}}}},f);this.insertChildNodes(i,g)},collapse:function(f){f.isExpanded(false);e.each(this.getDescendants(f,{depth:-1,includeNotSaved:true}),function(){this.$node.remove()})},insertChildNodes:function(i,g){var h=this,f=i;e.when(this.getSourceNodes(i.id)).done(function(l){for(var j in l){var k=new c(l[j],h);h.insertIntegral(k,f);f=k}if(g&&typeof g.onAfterFill==="function"){g.onAfterFill(i,l)}})},insertNew:function(j,k,f){var l=this,g=(f==="lastChild"||f==="firstChild"),i=new c({level:j.level+(g?1:0),parent:j.level===1&&!g?0:(g?j.id:j.parent),type:k},this);function h(){if(g){j.isExpanded(true);j.showCeIcon(true)}l.insert(i,f,j);i.insertPosition=f;i.relatedNodeId=j.id;i.showForm(true)}if(g&&!j.isExpanded()){this.expand(j,{onAfterFill:function(){h()}})}else{h()}},insert:function(j,f,h){if(f==="before"){h.$node.before(j.$node)}else{if(f==="after"){var g=h;if(h.isExpanded()){var i=this.getDescendants(h,{depth:1,index:-1,includeNotSaved:true});g=i===undefined?g:i}g.$node.after(j.$node)}else{if(f==="firstChild"){this.getNodeById(h.id).$node.after(j.$node)}else{if(f==="lastChild"){var i=this.getDescendants(h,{depth:1,index:-1,includeNotSaved:true});var g=i===undefined?h:i;g.$node.after(j.$node)}else{throw"Wrong position."}}}}},insertIntegral:function(f,g){if(g===undefined){this.$tree.append(f.$node)}else{g.$node.after(f.$node)}},makeEditable:function(f){f.showForm(true)},sortNodeInTree:function(i){var g=this,k=this.getSiblings(i);if(k.length>0){var j=!i.isExpanded()?[]:this.getDescendants(i,{depth:-1,includeNotSaved:true}),h=undefined;e.each(k,function(){if(g.options.sort(i,this)===-1){h=this;return false}});if(h===undefined){h=k[k.length-1];if(h.isExpanded()){h=this.getDescendants(g.getNodeById(i.parent),{depth:-1,index:-1,includeNotSaved:true})}h.$node.after(i.$node)}else{h.$node.before(i.$node)}i.$node.css("border","2px solid blue");var f=i.$node;e.each(j,function(){var l=this;f.after(l.$node);f=l.$node})}},save:function(g){var f=this;if(e.isFunction(f.options.onSave)){e.when(f.options.onSave(g)).done(function(h){g.id=h.id;g.name=h.name;if(typeof f.options.sort==="function"){f.sortNodeInTree(g)}g.render();g.showForm(false);g.isHovered(false)})}},saveCancel:function(f){f.showForm(false);if(!f.isSaved()){this._remove(f)}},remove:function(g){var f=this;if(g.isSaved()){if(e.isFunction(f.options.onDelete)){e.when(f.options.onDelete(g)).done(function(){f._remove(g)})}}else{this._remove(g)}},_remove:function(f){if(f.isExpanded()===true){this.collapse(f)}f.$node.remove()},isNodeDragging:function(f){if(f===undefined){return this._isNodeDragging}else{if(f===true){this._isNodeDragging=true;this.$tree.disableSelection()}else{this._isNodeDragging=false;this.$tree.enableSelection()}}},move:function(g,i,f){var h=this;if(e.isFunction(h.options.onMove)){e.when(h.options.onMove(g,i,f)).done(function(l){i.$node.css("backgroundColor","red");g.$node.css("backgroundColor","green");var k=h.getDescendants(g,{depth:-1,includeNotSaved:true}),n=h.getNodeById(g.parent),m=i.level-g.level;g.parent=f==="lastChild"?i.id:i.parent;g.level=i.level;if(f==="lastChild"&&!i.isExpanded()){g.$node.remove();e.each(k,function(){this.$node.remove()})}else{if(f==="lastChild"){g.level+=1;i.showCeIcon(true)}g.render();h.insert(g,f,i);if(k.length>0){var j=g.$node;if(f==="lastChild"){m+=1}e.each(k,function(){var o=this;o.level+=m;o.render();j.after(o.$node);o.$node.css("backgroundColor","green");j=o.$node})}}if(n!==undefined&&h.getDescendants(n,{depth:1,includeNotSaved:true}).length===0){n.isExpanded(false)}if(typeof h.options.sort==="function"){h.sortNodeInTree(g)}})}}};function c(g,f){this.manager=f;this.level=g.level;this.parent=g.parent;this.name=g.name;this.type=g.type;this.id=g.id;this.insertPosition=undefined;this.movePosition=undefined;this.relatedNodeId=undefined;this._isExpanded=false;this._isLoading=false;this._isSaved=g.id===undefined?false:true;this._isSelected=false;this._isHovered=false;this._isEditable=false;this.init()}c.prototype={getMovePosition:function(){return this.movePosition},setMovePosition:function(f){this.$node.removeClass(this.manager.options.classes.draggableBefore+" "+this.manager.options.classes.draggableAfter+" "+this.manager.options.classes.draggableLastChild);if(f!==undefined){this.$node.addClass(this.manager.options.classes.draggable+"-"+f);this.movePosition=f}},getId:function(){return this.id},getName:function(){return this.isEditable()?this.$input.val():this.name},getParent:function(){return this.parent},getInsertPosition:function(){return this.insertPosition},getRelatedNodeId:function(){return this.relatedNodeId},init:function(){this.$node=this.manager.$nodeTemplate.clone(false);this.$name=this.$node.find("."+this.manager.options.classes.name);this.$ceIcon=this.$node.find("."+this.manager.options.classes.ceIcon);this.$typeIcon=this.$node.find("."+this.manager.options.classes.typeIcon);this.$icon=this.$node.find("."+this.manager.options.classes.icon);this.$action=this.$node.find("."+this.manager.options.classes.action);this.$indent=this.$node.find("."+this.manager.options.classes.indent);this.$saveButton=this.$node.find("."+this.manager.options.classes.saveButton);this.$cancelButton=this.$node.find("."+this.manager.options.classes.cancelButton);this.$input=this.$node.find("input");this.render();this.attachEvents();this.$node.data("bs.gtreetable.gtreetablenode",this)},render:function(){this.$name.html(this.name);if(this.id!==undefined){this.$node.data("id",this.id);this.$node.addClass(this.manager.options.classes.node+this.id);this.$node.addClass(this.manager.options.classes.saved);if(this.manager.options.draggable===true){this.$node.addClass(this.manager.options.classes.draggable)}}this.$node.attr("data-parent",this.parent);this.$node.attr("data-level",this.level);this.$indent.css("marginLeft",((parseInt(this.level,10)-1)*this.manager.options.nodeIndent)+"px").html("&zwnj;");if(this.type!==undefined&&this.manager.options.types[this.type]!==undefined){this.$typeIcon.addClass(this.manager.options.types[this.type]).show()}},attachEvents:function(){var g=this;this.$node.mouseover(function(){if(!(g.manager.options.draggable===true&&g.manager.isNodeDragging()===true)){g.$node.addClass(g.manager.options.classes.hovered);g.isHovered(true)}});this.$node.mouseleave(function(){g.$node.removeClass(g.manager.options.classes.hovered);g.isHovered(false)});this.$name.click(function(h){if(g.isSelected()){if(e.isFunction(g.manager.options.onUnselect)){g.manager.options.onUnselect(g)}g.isSelected(false)}else{var i=g.manager.getSelectedNodes();if(g.manager.options.multiselect===false){if(i.length===1){i[0].isSelected(false)}}else{if(!isNaN(g.manager.options.multiselect)&&g.manager.options.multiselect===i.length){if(e.isFunction(g.options.onSelectOverflow)){g.options.onSelectOverflow(g)}h.preventDefault()}}g.isSelected(true);if(e.isFunction(g.manager.options.onSelect)){g.manager.options.onSelect(g)}}});this.$ceIcon.click(function(h){if(!g.isExpanded()){g.manager.expand(g)}else{g.manager.collapse(g)}});if(g.manager.options.onDragCanExpand===true){this.$ceIcon.mouseover(function(h){if(g.manager.options.draggable===true&&g.manager.isNodeDragging()===true){if(!g.isExpanded()){g.manager.expand(g)}}})}e.each(this.manager.actions,function(h,i){g.$node.find("."+g.manager.options.classes.action+"-"+h).click(function(j){i.event(g,g.manager)})});this.$saveButton.click(function(){g.manager.save(g)});this.$cancelButton.click(function(){g.manager.saveCancel(g)});if(g.manager.options.draggable===true){function f(j,i){var h=i.outerHeight()-(j.helper.outerHeight()/2),k=j.offset.top-i.offset().top;if(k<=(h*0.3)){return"before"}else{if(k<=(h*0.7)){return"lastChild"}else{return"after"}}}this.$node.draggable({scroll:true,refreshPositions:g.manager.options.onDragCanExpand,helper:function(i){var h=g.manager.getNode(e(this));return'<mark class="'+g.manager.options.classes.draggableHelper+'">'+h.name+"</mark>"},cursorAt:{top:0,left:0},handle:"."+g.manager.options.classes.handleIcon,start:function(h){e(this).data("bs.gtreetable.gtreetablenode.startingScrollTop",window.pageYOffset);g.manager.isNodeDragging(true)},stop:function(h){g.manager.isNodeDragging(false)},drag:function(k,j){var h=parseInt(e(this).data("bs.gtreetable.gtreetablenode.startingScrollTop"));j.position.top-=h;var i=e(this).data("bs.gtreetable.gtreetablenode.currentDroppable");if(i){g.manager.getNode(i).setMovePosition(f(j,i))}}}).droppable({accept:"."+g.manager.options.classes.node,over:function(h,i){var j=e(this);g.manager.getNode(j).setMovePosition(f(i,j));i.draggable.data("bs.gtreetable.gtreetablenode.currentDroppable",j)},out:function(h,i){i.draggable.removeData("bs.gtreetable.gtreetablenode.currentDroppable");g.manager.getNode(e(this)).setMovePosition()},drop:function(i,j){var k=e(this),l=g.manager.getNode(k),h=l.getMovePosition();j.draggable.removeData("bs.gtreetable.gtreetablenode.currentDroppable");l.setMovePosition();g.manager.move(g.manager.getNode(j.draggable),l,h)}})}},isLoading:function(f){if(f===undefined){return this._isLoading}else{if(f){this.$name.addClass(this.manager.options.classes.loading);this._isLoading=true}else{this.$name.removeClass(this.manager.options.classes.loading);this._isLoading=false}}},isSaved:function(f){if(f===undefined){return this._isSaved}else{if(f){this.$name.addClass(this.manager.options.classes.saved);this._isSaved=true}else{this.$name.removeClass(this.manager.options.classes.saved);this._isSaved=false}}},isSelected:function(f){if(f===undefined){return this._isSelected}else{if(f){this.$node.addClass(this.manager.options.classes.selected);this._isSelected=true}else{this.$node.removeClass(this.manager.options.classes.selected);this._isSelected=false}}},isExpanded:function(f){if(f===undefined){return this._isExpanded}else{if(f){this.$node.addClass(this.manager.options.classes.expanded).removeClass(this.manager.options.classes.collapsed);this._isExpanded=true}else{this.$node.addClass(this.manager.options.classes.collapsed).removeClass(this.manager.options.classes.expanded);this._isExpanded=false}}},isHovered:function(f){if(f===undefined){return this._isHovered}else{if(f){this.$node.addClass(this.manager.options.classes.hovered);this._isHovered=true}else{this.$node.removeClass(this.manager.options.classes.hovered);this.$node.find(".btn-group").removeClass("open");this._isHovered=false}}},isEditable:function(f){if(f===undefined){return this._isEditable}else{this._isEditable=f}},showCeIcon:function(f){this.$ceIcon.css("visibility",f?"visible":"hidden")},showForm:function(f){if(f===true){this.isEditable(true);this.$input.val(this.name);this.$name.addClass("hide");this.$action.removeClass("hide");this.$input.focus()}else{this.isEditable(false);this.$name.removeClass("hide");this.$action.addClass("hide")}}};function d(g,h){var f=null;this.each(function(){var k=e(this),j=k.data("bs.gtreetable"),i=e.extend({},e.fn.gtreetable.defaults,k.data(),typeof g==="object"&&g);if(!j){j=new b(this,i);k.data("bs.gtreetable",j)}if(typeof g==="string"){f=j[g](h)}});if(!f){f=this}return f}var a=e.fn.gtreetable;e.fn.gtreetable=d;e.fn.gtreetable.Constructor=b;e.fn.gtreetable.defaults={nodeIndent:16,language:"en",inputWidth:"60%",readonly:false,multiselect:false,draggable:false,onDragCanExpand:false,showExpandIconOnEmpty:false,languages:{en:{save:"Save",cancel:"Cancel",action:"Action",actionAdd:"Add",actionEdit:"Edit",actionDelete:"Delete",deleteConfirm:"Are you sure?"}},defaultActions:[{name:"Add before",event:function(g,f){f.insertNew(g,"default","before")}},{name:"Add after",event:function(g,f){f.insertNew(g,"default","after")}},{name:"Add first child",event:function(g,f){f.insertNew(g,"default","firstChild")}},{name:"Add last child",event:function(g,f){f.insertNew(g,"default","lastChild")}},{divider:true},{name:"{actionEdit}",event:function(g,f){f.makeEditable(g)}},{name:"{actionDelete}",event:function(g,f){if(confirm(f.language.deleteConfirm)){f.remove(g)}}}],classes:{node:"node",loading:"node-loading",selected:"node-selected",hovered:"node-hovered",expanded:"node-expanded",collapsed:"node-collapsed",draggable:"node-draggable",draggableHelper:"node-draggable-helper",draggablePointer:"node-draggable-pointer",draggableBefore:"node-draggable-before",draggableAfter:"node-draggable-after",draggableLastChild:"node-draggable-lastChild",saved:"node-saved",name:"node-name",icon:"node-icon",selectedIcon:"node-icon-selected",ceIcon:"node-icon-ce",typeIcon:"node-icon-type",handleIcon:"node-icon-handle",action:"node-action",indent:"node-indent",saveButton:"node-save",cancelButton:"node-cancel"}};e.fn.gtreetable.noConflict=function(){e.fn.gtreetable=a;return this}}(jQuery));